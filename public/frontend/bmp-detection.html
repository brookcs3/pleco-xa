<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BPM Detection - Pleco-XA Demo</title>
    <style>
      body {
        margin: 0;
        padding: 2rem;
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
        color: white;
        overflow-x: hidden;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        position: relative;
      }

      .back-link {
        position: absolute;
        top: -1rem;
        left: 0;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 0.9rem;
      }

      .back-link:hover {
        color: white;
      }

      h1 {
        text-align: center;
        font-size: 3rem;
        margin-bottom: 1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        text-align: center;
        font-size: 1.2rem;
        opacity: 0.8;
        margin-bottom: 3rem;
      }

      .demo-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 3rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 2rem;
      }

      .file-input-wrapper {
        text-align: center;
        margin-bottom: 2rem;
      }

      .file-input {
        display: none;
      }

      .file-label {
        display: inline-block;
        padding: 1rem 2rem;
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        border: 2px solid transparent;
      }

      .file-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .bpm-display {
        text-align: center;
        margin: 2rem 0;
      }

      .bpm-value {
        font-size: 4rem;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 0.5rem;
      }

      .bpm-label {
        font-size: 1.2rem;
        opacity: 0.8;
      }

      .confidence-bar {
        width: 100%;
        height: 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin: 1rem 0;
      }

      .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcf7f);
        width: 0%;
        transition: width 0.5s ease;
        border-radius: 10px;
      }

      .pulse-indicator {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: radial-gradient(circle, #ffd700, #ff6b6b);
        margin: 2rem auto;
        position: relative;
        overflow: hidden;
      }

      .pulse-wave {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.8);
        transform: translate(-50%, -50%);
      }

      .analysis-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 2rem;
        opacity: 0;
        transform: translateY(20px);
      }

      .detail-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
      }

      .detail-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #ffd700;
        margin-bottom: 0.5rem;
      }

      .detail-label {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .sample-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      .sample-btn {
        padding: 0.8rem 1.5rem;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 25px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }

      .sample-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      .playback-controls {
        text-align: center;
        margin: 2rem 0;
      }

      .play-btn {
        padding: 1rem 2rem;
        background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
        border: none;
        border-radius: 50px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 0.5rem;
      }

      .play-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .play-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/" class="back-link">‚Üê Back to Demos</a>

      <h1 id="title">üéµ BPM Detection</h1>
      <p class="subtitle">
        Real-time tempo analysis with animated visualizations
      </p>

      <div class="demo-section" id="demoSection">
        <div class="file-input-wrapper">
          <input
            type="file"
            id="audioFile"
            class="file-input"
            accept="assets/audio/*"
          />
          <label for="audioFile" class="file-label" id="fileLabel">
            üéµ Choose Audio File
          </label>
        </div>

        <div class="sample-buttons">
          <button class="sample-btn" data-sample="12-8-Jazzy-Drumset-03.aif">
            Jazz Drums
          </button>
          <button
            class="sample-btn"
            data-sample="Bassline For Doppler Song - 11.aif"
          >
            Bassline
          </button>
          <button class="sample-btn" data-sample="Drive Through Beat.aif">
            Drive Beat
          </button>
        </div>

        <div class="playback-controls" id="playbackControls" style="opacity: 0">
          <button class="play-btn" id="playBtn">‚ñ∂Ô∏è Play Loop</button>
          <button class="play-btn" id="stopBtn">‚èπÔ∏è Stop</button>
        </div>

        <div class="bpm-display" id="bpmDisplay" style="opacity: 0">
          <div class="bpm-value" id="bpmValue">--</div>
          <div class="bpm-label">Beats Per Minute</div>

          <div class="confidence-bar">
            <div class="confidence-fill" id="confidenceFill"></div>
          </div>
          <div style="text-align: center; margin-top: 0.5rem; opacity: 0.8">
            Confidence:
            <span id="confidenceText">0%</span>
          </div>

          <div class="pulse-indicator" id="pulseIndicator">
            <div class="pulse-wave" id="pulseWave"></div>
          </div>
        </div>

        <div class="analysis-details" id="analysisDetails">
          <div class="detail-card">
            <div class="detail-value" id="beatDuration">--</div>
            <div class="detail-label">Beat Duration (ms)</div>
          </div>
          <div class="detail-card">
            <div class="detail-value" id="barDuration">--</div>
            <div class="detail-label">Bar Duration (s)</div>
          </div>
          <div class="detail-card">
            <div class="detail-value" id="timeSignature">4/4</div>
            <div class="detail-label">Time Signature</div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script type="module">
      import { detectBPM, loadAudioBuffer } from 'pleco-xa';

      // Enhanced BPM detection with half-time/double-time correction
      function detectBPM(audioData, sampleRate) {
        const frameSize = 2048
        const hopSize = 512
        const numFrames = Math.floor((audioData.length - frameSize) / hopSize)

        // Calculate onset strength using RMS energy differences
        const onsetStrength = []
        for (let i = 1; i < numFrames; i++) {
          const start = i * hopSize
          const frame = audioData.slice(start, start + frameSize)

          const currentRMS = Math.sqrt(
            frame.reduce((sum, s) => sum + s * s, 0) / frameSize,
          )
          const prevFrame = audioData.slice((i - 1) * hopSize, start)
          const prevRMS = Math.sqrt(
            prevFrame.reduce((sum, s) => sum + s * s, 0) / frameSize,
          )

          onsetStrength.push(Math.max(0, currentRMS - prevRMS))
        }

        // Autocorrelation to find periodic patterns
        const minBPM = 60
        const maxBPM = 180
        const minPeriod = Math.floor(((60 / maxBPM) * sampleRate) / hopSize)
        const maxPeriod = Math.floor(((60 / minBPM) * sampleRate) / hopSize)

        const candidates = []

        for (
          let period = minPeriod;
          period <= maxPeriod && period < onsetStrength.length / 2;
          period++
        ) {
          let correlation = 0
          let count = 0

          for (let i = 0; i < onsetStrength.length - period; i++) {
            correlation += onsetStrength[i] * onsetStrength[i + period]
            count++
          }

          correlation /= count
          const bpm = (60 * sampleRate) / (period * hopSize)

          candidates.push({
            bpm: bpm,
            correlation: correlation,
            period: period,
          })
        }

        // Sort by correlation strength
        candidates.sort((a, b) => b.correlation - a.correlation)

        let bestBPM = candidates[0].bpm
        let bestCorrelation = candidates[0].correlation

        // Check for half-time/double-time issues
        // If the best BPM is under 90, check if double-time makes more sense
        if (bestBPM < 90) {
          const doubleBPM = bestBPM * 2
          if (doubleBPM <= 180) {
            // Find correlation for double-time
            const doublePeriod = Math.floor(candidates[0].period / 2)
            if (doublePeriod >= minPeriod) {
              let doubleCorrelation = 0
              let count = 0

              for (let i = 0; i < onsetStrength.length - doublePeriod; i++) {
                doubleCorrelation +=
                  onsetStrength[i] * onsetStrength[i + doublePeriod]
                count++
              }
              doubleCorrelation /= count

              // If double-time correlation is reasonably strong, prefer it
              if (doubleCorrelation > bestCorrelation * 0.7) {
                bestBPM = doubleBPM
                bestCorrelation = doubleCorrelation
                console.log(
                  `Half-time detected: ${candidates[0].bpm.toFixed(1)} -> ${doubleBPM.toFixed(1)} BPM`,
                )
              }
            }
          }
        }

        // If the best BPM is over 160, check if half-time makes more sense
        if (bestBPM > 160) {
          const halfBPM = bestBPM / 2
          if (halfBPM >= 60) {
            // Find correlation for half-time
            const halfPeriod = candidates[0].period * 2
            if (
              halfPeriod <= maxPeriod &&
              halfPeriod < onsetStrength.length / 2
            ) {
              let halfCorrelation = 0
              let count = 0

              for (let i = 0; i < onsetStrength.length - halfPeriod; i++) {
                halfCorrelation +=
                  onsetStrength[i] * onsetStrength[i + halfPeriod]
                count++
              }
              halfCorrelation /= count

              // If half-time correlation is reasonably strong, prefer it
              if (halfCorrelation > bestCorrelation * 0.8) {
                bestBPM = halfBPM
                bestCorrelation = halfCorrelation
                console.log(
                  `Double-time detected: ${candidates[0].bpm.toFixed(1)} -> ${halfBPM.toFixed(1)} BPM`,
                )
              }
            }
          }
        }

        return {
          bpm: bestBPM,
          confidence: bestCorrelation,
        }
      }

      // Load audio buffer (from BeaatsLoops approach)
      async function loadAudioBuffer(url, context = new AudioContext()) {
        const res = await fetch(url)
        const arr = await res.arrayBuffer()
        return await context.decodeAudioData(arr)
      }

      function debugLog(...args) {
        console.log('[PLECO-XA DEBUG]', ...args)
      }

      // GSAP Animations Setup
      gsap.registerPlugin()

      // Initial page animations
      gsap
        .timeline()
        .from('#title', { duration: 1, y: -50, opacity: 0, ease: 'bounce.out' })
        .from('.subtitle', { duration: 0.8, y: 20, opacity: 0 }, '-=0.5')
        .from(
          '#demoSection',
          { duration: 1, scale: 0.9, opacity: 0, ease: 'back.out(1.7)' },
          '-=0.3',
        )

      let audioContext
      let currentBPM = 120
      let pulseAnimation
      let currentAudioBuffer = null
      let currentSource = null
      let isPlaying = false

      // File input handling
      document
        .getElementById('audioFile')
        .addEventListener('change', handleFileUpload)

      // Sample button handling
      document.querySelectorAll('.sample-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          console.log('Sample button clicked:', btn.dataset.sample)
          const sample = btn.dataset.sample
          loadSampleFile(`/assets/audio/${sample}`)
        })
      })

      // Playback controls
      document.getElementById('playBtn').addEventListener('click', playAudio)
      document.getElementById('stopBtn').addEventListener('click', stopAudio)

      async function handleFileUpload(event) {
        const file = event.target.files[0]
        console.log('File selected:', file?.name, file?.type)
        if (!file) return

        await analyzeAudio(file)
      }

      async function loadSampleFile(url) {
        try {
          console.log('Loading sample from:', url)

          if (!audioContext) {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)()
          }

          const audioBuffer = await loadAudioBuffer(url, audioContext)
          currentAudioBuffer = audioBuffer
          console.log('Audio buffer loaded:', audioBuffer.duration + 's')

          const audioData = audioBuffer.getChannelData(0)
          const bpmResult = detectBPM(audioData, audioBuffer.sampleRate)

          debugLog('BPM Detection Result:', bpmResult)

          animateBPMResult(bpmResult)
        } catch (error) {
          console.error('Error loading sample:', error)
          alert(`Error loading sample: ${error.message}`)
        }
      }

      async function analyzeAudio(file) {
        try {
          console.log('Analyzing file:', file.name, file.size, 'bytes')

          if (!audioContext) {
            audioContext = new (window.AudioContext ||
              window.webkitAudioContext)()
          }

          const arrayBuffer = await file.arrayBuffer()
          const audioBuffer = await audioContext.decodeAudioData(arrayBuffer)
          currentAudioBuffer = audioBuffer
          console.log('Audio buffer loaded:', audioBuffer.duration + 's')

          const audioData = audioBuffer.getChannelData(0)
          const bpmResult = detectBPM(audioData, audioBuffer.sampleRate)

          debugLog('BPM Detection Result:', bpmResult)

          animateBPMResult(bpmResult)
        } catch (error) {
          console.error('Error analyzing audio:', error)
          alert(`Error analyzing audio: ${error.message}`)
        }
      }

      function animateBPMResult(bpmResult) {
        const { bpm, confidence } = bpmResult
        currentBPM = bpm

        console.log('Animating BPM:', bpm, 'confidence:', confidence)

        // Show displays first
        gsap.to('#bpmDisplay', {
          duration: 0.5,
          opacity: 1,
          ease: 'power2.out',
        })
        gsap.to('#playbackControls', {
          duration: 0.5,
          opacity: 1,
          ease: 'power2.out',
        })

        // Set BPM value directly (simpler approach)
        document.getElementById('bpmValue').textContent = Math.round(bpm)

        // Update confidence text and bar (invert the correlation value)
        const actualConfidence = Math.min((1 - confidence) * 100, 100)
        const confidencePercent = actualConfidence.toFixed(1)
        document.getElementById('confidenceText').textContent =
          `${confidencePercent}%`

        gsap.to('#confidenceFill', {
          duration: 1,
          width: `${actualConfidence}%`,
          ease: 'power2.out',
          delay: 0.3,
        })

        // Update analysis details
        const beatDuration = Math.round((60 / bpm) * 1000)
        const barDuration = ((60 / bpm) * 4).toFixed(2)

        document.getElementById('beatDuration').textContent = beatDuration
        document.getElementById('barDuration').textContent = barDuration

        // Show analysis details
        gsap.to('#analysisDetails', {
          duration: 0.8,
          opacity: 1,
          y: 0,
          ease: 'back.out(1.7)',
          delay: 0.5,
        })

        // Start pulse animation
        startPulseAnimation(bpm)

        // Color-code confidence (using the corrected confidence value)
        const confidenceFill = document.getElementById('confidenceFill')
        if (actualConfidence > 70) {
          confidenceFill.style.background =
            'linear-gradient(90deg, #6bcf7f, #4ecdc4)'
        } else if (actualConfidence > 40) {
          confidenceFill.style.background =
            'linear-gradient(90deg, #ffd93d, #ff9f43)'
        } else {
          confidenceFill.style.background =
            'linear-gradient(90deg, #ff6b6b, #ee5a52)'
        }
      }

      function startPulseAnimation(bpm) {
        if (pulseAnimation) {
          pulseAnimation.kill()
        }

        const beatInterval = 60 / bpm

        pulseAnimation = gsap
          .timeline({ repeat: -1 })
          .to('#pulseWave', {
            duration: beatInterval * 0.1,
            scale: 4,
            opacity: 0,
            ease: 'power2.out',
          })
          .set('#pulseWave', { scale: 1, opacity: 0.8 })
          .to('#pulseIndicator', {
            duration: beatInterval * 0.05,
            scale: 1.1,
            ease: 'power2.out',
          })
          .to('#pulseIndicator', {
            duration: beatInterval * 0.05,
            scale: 1,
            ease: 'power2.out',
          })
          .to({}, { duration: beatInterval * 0.8 }) // Wait for next beat
      }

      async function playAudio() {
        if (!currentAudioBuffer || isPlaying) return

        try {
          if (audioContext.state === 'suspended') {
            await audioContext.resume()
          }

          stopAudio() // Stop any existing playback

          currentSource = audioContext.createBufferSource()
          currentSource.buffer = currentAudioBuffer
          currentSource.connect(audioContext.destination)

          // Enable looping for consistent BPM analysis
          currentSource.loop = true
          currentSource.loopStart = 0
          currentSource.loopEnd = currentAudioBuffer.duration

          currentSource.onended = () => {
            isPlaying = false
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Play Loop'
          }

          currentSource.start(0)
          isPlaying = true
          document.getElementById('playBtn').textContent = '‚è∏Ô∏è Looping'

          debugLog('Audio loop playback started')
        } catch (error) {
          console.error('Error playing audio:', error)
        }
      }

      function stopAudio() {
        if (currentSource) {
          try {
            currentSource.stop()
          } catch (error) {
            // Source may already be stopped
          }
          currentSource = null
        }
        isPlaying = false
        document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Play Loop'
      }

      // Hover animations for interactive elements
      document.querySelectorAll('.sample-btn').forEach((btn) => {
        btn.addEventListener('mouseenter', () => {
          gsap.to(btn, { duration: 0.3, scale: 1.05, ease: 'back.out(1.7)' })
        })

        btn.addEventListener('mouseleave', () => {
          gsap.to(btn, { duration: 0.3, scale: 1, ease: 'power2.out' })
        })
      })

      const fileLabel = document.getElementById('fileLabel')
      fileLabel.addEventListener('mouseenter', () => {
        gsap.to(fileLabel, {
          duration: 0.3,
          scale: 1.05,
          ease: 'back.out(1.7)',
        })
      })

      fileLabel.addEventListener('mouseleave', () => {
        gsap.to(fileLabel, { duration: 0.3, scale: 1, ease: 'power2.out' })
      })
    </script>
  </body>
</html>
