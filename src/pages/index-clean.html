<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pleco-XA Audio Analysis</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2d2d2d 100%);
      color: #ffffff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .title {
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(45deg, #00ff88, #00d4ff, #8800ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
      text-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
    }

    .subtitle {
      font-size: 1.2rem;
      color: #aaa;
      font-weight: 300;
    }

    .samples-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 40px;
    }

    .sample-btn {
      background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
      border: 2px solid #444;
      color: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sample-btn:hover {
      background: linear-gradient(145deg, #00ff88, #00d4ff);
      border-color: #00ff88;
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 255, 136, 0.3);
    }

    .analysis-section {
      background: rgba(25, 25, 25, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .playback-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .control-btn {
      background: linear-gradient(145deg, #333, #222);
      border: 2px solid #555;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
    }

    .control-btn:hover {
      background: linear-gradient(145deg, #00ff88, #00d4ff);
      border-color: #00ff88;
      transform: scale(1.05);
    }

    .bpm-display {
      font-size: 2.5rem;
      font-weight: 900;
      color: #00ff88;
      text-align: center;
      margin: 20px 0;
      text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
    }

    .waveform-canvas {
      width: 100%;
      height: 200px;
      background: #111;
      border-radius: 10px;
      border: 2px solid #333;
    }

    .loop-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .loop-btn {
      background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
      border: 1px solid #444;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
      font-weight: 500;
    }

    .loop-btn:hover {
      background: linear-gradient(145deg, #ff6b35, #ff8e53);
      border-color: #ff6b35;
    }

    .analysis-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .analysis-card {
      background: rgba(30, 30, 30, 0.8);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .analysis-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 255, 136, 0.1);
    }

    .card-title {
      font-size: 14px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .card-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #00ff88;
      margin-bottom: 5px;
    }

    .card-description {
      font-size: 12px;
      color: #666;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="title">PLECO-XA</h1>
      <p class="subtitle">Advanced Audio Loop Analysis & BPM Detection</p>
    </header>

    <div class="samples-grid">
      <button class="sample-btn" data-sample="12-8-Jazzy-Drumset-03.aif">Jazzy Drumset</button>
      <button class="sample-btn" data-sample="Bassline For Doppler Song - 11.aif">Doppler Bassline</button>
      <button class="sample-btn" data-sample="Bassline For Doppler Song longer.aif">Extended Bassline</button>
      <button class="sample-btn" data-sample="Drive Through Beat.aif">Drive Through Beat</button>
    </div>

    <div class="analysis-section">
      <div class="playback-controls">
        <button class="control-btn" id="playBtn">‚ñ∂Ô∏è Play</button>
        <button class="control-btn" id="stopBtn">‚èπÔ∏è Stop</button>
      </div>

      <div class="bpm-display">
        <span id="bpmValue">--</span> BPM
      </div>

      <div class="waveform-container">
        <h3>Waveform & Loop Detection</h3>
        <canvas class="waveform-canvas" id="waveformCanvas" width="800" height="200"></canvas>
        <div class="loop-controls">
          <button class="loop-btn" id="detectLoopBtn">üîç Detect Loop</button>
        </div>
      </div>

      <div class="analysis-cards">
        <div class="analysis-card">
          <h4 class="card-title">Track Info</h4>
          <div class="card-value" id="trackName">No track loaded</div>
          <p class="card-description" id="trackStatus">Load a sample to begin</p>
        </div>

        <div class="analysis-card">
          <h4 class="card-title">Loop Status</h4>
          <div class="card-value" id="loopInfo">Full Track</div>
          <p class="card-description">Current loop boundaries</p>
        </div>

        <div class="analysis-card">
          <h4 class="card-title">Audio Format</h4>
          <div class="card-value" id="audioFormat">--</div>
          <p class="card-description">Decoded audio information</p>
        </div>
      </div>
    </div>
  </div>

<!--  put this once, right before </body> -->
<script type="module">
  /* ------------------------------------------------------------------
     1.  Import Librosa helpers (case-sensitive, exact export names)
  ------------------------------------------------------------------ */
  import { quick_tempo } from '/src/core/librosa-tempo.js';
  import {
    computeChroma,
    stackMemory,
    recurrenceMatrix,
    recurrenceToLag
  } from '/src/core/librosa-recurrence.js';

  /* ------------------------------------------------------------------
     2.  Shared state
  ------------------------------------------------------------------ */
  let audioCtx            = null;
  let buffer              = null;
  let bpm                 = 120;
  let loop                = { start: 0, end: 1 };
  let srcNode             = null;
  let isPlaying           = false;
  let playheadRAF         = 0;

  /* ------------------------------------------------------------------
     3.  DOM helpers
  ------------------------------------------------------------------ */
  const $ = (id) => document.getElementById(id);

  const log = (...m) => console.log('üéõ', ...m);

  function uiTrackInfo(name, status) {
    $('trackName').textContent   = name;
    $('trackStatus').textContent = status;
  }

  function uiLoopInfo() {
    if (!buffer) return;
    const d = (loop.end - loop.start) * buffer.duration;
    $('loopInfo').textContent =
      loop.start === 0 && loop.end === 1 ? 'Full Track' : `${d.toFixed(2)} s Loop`;
  }

  /* ------------------------------------------------------------------
     4.  Load & decode audio
  ------------------------------------------------------------------ */
  async function loadSample(url, label) {
    try {
      log('üì•', url);
      uiTrackInfo(label, 'Loading‚Ä¶');

      if (!audioCtx)
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      const res   = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const buf   = await audioCtx.decodeAudioData(await res.arrayBuffer());
      buffer      = buf;
      loop        = { start: 0, end: 1 };   // reset loop on new track

      $('audioFormat').textContent =
        `${buf.numberOfChannels} ch ‚Ä¢ ${buf.sampleRate} Hz`;
      drawWaveform();
      detectBPM();
      uiLoopInfo();
      uiTrackInfo(label, `${buf.duration.toFixed(2)} s`);
    } catch (e) {
      console.error(e);
      uiTrackInfo('Error', e.message);
    }
  }

  /* ------------------------------------------------------------------
     5.  BPM detection (quick_tempo demo)
  ------------------------------------------------------------------ */
  function detectBPM() {
    if (!buffer) return;
    const y  = buffer.getChannelData(0);
    const sr = buffer.sampleRate;
    bpm      = Math.round(quick_tempo(y, sr));
    $('bpmValue').textContent = bpm;
    log('BPM', bpm);
  }

  /* ------------------------------------------------------------------
     6.  Simple recurrence-based loop detector (demo)
  ------------------------------------------------------------------ */
  function detectLoop() {
    if (!buffer) return;

    const chroma = computeChroma(buffer);
    const feats  = stackMemory(chroma, 8, 3);
    const R      = recurrenceMatrix(feats, null, 1, 'euclidean', true);
    const lag    = recurrenceToLag(R);
    const best   = lag.indexOf(Math.max(...lag.slice(1)));

    if (best <= 1) {
      loop = { start: 0, end: 1 };
      uiLoopInfo();
      drawWaveform();
      return;
    }

    const hop     = 512;
    const seconds = best * hop / buffer.sampleRate;
    loop = { start: 0, end: seconds / buffer.duration };
    uiLoopInfo();
    drawWaveform();
    log('Loop', seconds.toFixed(2), 's');
  }

  /* ------------------------------------------------------------------
     7.  Playback controls
  ------------------------------------------------------------------ */
  async function play() {
    if (!buffer) return alert('Load a track first');
    if (isPlaying) return stop();

    if (audioCtx.state === 'suspended') await audioCtx.resume();

    srcNode              = audioCtx.createBufferSource();
    srcNode.buffer       = buffer;
    srcNode.loop         = true;
    srcNode.loopStart    = loop.start * buffer.duration;
    srcNode.loopEnd      = loop.end   * buffer.duration;
    srcNode.connect(audioCtx.destination);
    srcNode.start();

    isPlaying            = true;
    $('playBtn').textContent = '‚è∏Ô∏è Pause';
    playheadRAF          = requestAnimationFrame(drawWaveform);
  }

  function stop() {
    if (srcNode) { try { srcNode.stop(); } catch {} }
    srcNode      = null;
    isPlaying    = false;
    $('playBtn').textContent = '‚ñ∂Ô∏è Play';
    cancelAnimationFrame(playheadRAF);
    drawWaveform();
  }

  /* ------------------------------------------------------------------
     8.  Waveform + playhead
  ------------------------------------------------------------------ */
  function drawWaveform() {
    const c   = $('waveformCanvas');
    const ctx = c.getContext('2d');
    const w   = c.width, h = c.height;

    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, w, h);

    if (!buffer) return;

    // waveform
    const data = buffer.getChannelData(0);
    const step = Math.ceil(data.length / w);
    ctx.strokeStyle = '#0f8';
    ctx.beginPath();
    for (let i = 0; i < w; i++) {
      const s = data.slice(i * step, (i + 1) * step);
      const max = Math.max(...s), min = Math.min(...s);
      ctx.moveTo(i, (1 - max) * h / 2);
      ctx.lineTo(i, (1 - min) * h / 2);
    }
    ctx.stroke();

    // loop shade
    ctx.fillStyle = 'rgba(255,215,0,0.15)';
    ctx.fillRect(loop.start * w, 0, (loop.end - loop.start) * w, h);

    // playhead
    if (isPlaying) {
      const pos = ((audioCtx.currentTime - srcNode.startTime) %
                   (srcNode.loopEnd - srcNode.loopStart)) + srcNode.loopStart;
      const x   = (pos / buffer.duration) * w;
      ctx.strokeStyle = '#f44';
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
      playheadRAF = requestAnimationFrame(drawWaveform);
    }
  }

  /* ------------------------------------------------------------------
     9.  Wire UI buttons
  ------------------------------------------------------------------ */
  document.querySelectorAll('.sample-btn').forEach(btn =>
    btn.addEventListener('click', () =>
      loadSample(`/audio/${btn.dataset.sample}`, btn.textContent.trim()))
  );
  $('playBtn')       .addEventListener('click', play);
  $('stopBtn')       .addEventListener('click', stop);
  $('detectLoopBtn') .addEventListener('click', detectLoop);
</script>
</body>
</html>