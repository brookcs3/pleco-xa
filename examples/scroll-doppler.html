<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doppler Scroll Demo</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
    }
    section {
      height: 100vh;
      scroll-snap-align: start;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #page2 { background: #222; }
    .progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      width: 0;
      background: #0f0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="progress"></div>
  <section id="page1"><h1>Loop 1</h1></section>
  <section id="page2"></section>
  <section id="page3"><h1>Loop 2</h1></section>

  <script type="module">
    import { librosaLoopAnalysis } from '../src/index.js';
    import Lenis from 'https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.5/dist/lenis.mjs';
    import gsap from 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js';
    import { ScrollTrigger } from 'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js';

    gsap.registerPlugin(ScrollTrigger);

    const lenis = new Lenis({ smooth: true });
    function raf(time) {
      lenis.raf(time);
      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    const loops = [
      { url: 'loop1.mp3', buffer: null, source: null, gain: ctx.createGain(), filter: ctx.createBiquadFilter() },
      { url: 'loop2.mp3', buffer: null, source: null, gain: ctx.createGain(), filter: ctx.createBiquadFilter() }
    ];

    loops.forEach(l => {
      l.gain.gain.value = 0;
      l.filter.frequency.value = 20000;
      l.filter.connect(l.gain).connect(ctx.destination);
    });

    async function loadLoop(loop) {
      const res = await fetch(loop.url);
      const arrayBuffer = await res.arrayBuffer();
      loop.buffer = await ctx.decodeAudioData(arrayBuffer);
      const analysis = await librosaLoopAnalysis(loop.buffer);
      loop.loopStart = analysis.loopStart;
      loop.loopEnd = analysis.loopEnd;
    }

    await Promise.all(loops.map(loadLoop));

    function createSources() {
      loops.forEach(loop => {
        loop.source = ctx.createBufferSource();
        loop.source.buffer = loop.buffer;
        loop.source.loop = true;
        loop.source.loopStart = loop.loopStart;
        loop.source.loopEnd = loop.loopEnd;
        loop.source.connect(loop.filter);
        loop.source.start();
      });
    }

    createSources();

    const progressBar = document.querySelector('.progress');

    ScrollTrigger.create({
      start: 'top top',
      end: 'bottom bottom',
      onUpdate: self => {
        const ratio = self.progress;
        progressBar.style.width = `${ratio * 100}%`;
        updateAudio(ratio);
      }
    });

    function updateAudio(ratio) {
      if (ratio < 0.5) {
        const t = ratio / 0.5;
        loops[0].gain.gain.value = 1 - t;
        loops[1].gain.gain.value = t;
        loops[1].filter.type = 'lowpass';
        loops[1].filter.frequency.value = 500 + t * 19500;
        loops[0].filter.type = 'highpass';
        loops[0].filter.frequency.value = 500 + t * 19500;
        loops[0].source.playbackRate.value = 1;
        loops[1].source.playbackRate.value = 1 + t * 0.05;
      } else {
        const t = (ratio - 0.5) / 0.5;
        loops[0].gain.gain.value = 1 - t;
        loops[1].gain.gain.value = t;
        loops[1].filter.type = 'lowpass';
        loops[1].filter.frequency.value = 500 + (1 - t) * 19500;
        loops[0].filter.type = 'highpass';
        loops[0].filter.frequency.value = 500 + t * 19500;
        loops[0].source.playbackRate.value = 1 - t * 0.05;
        loops[1].source.playbackRate.value = 1;
      }
    }
  </script>
</body>
</html>
