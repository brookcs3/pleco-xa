<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doppler Scroll Demo</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
    }
    section {
      height: 100vh;
      scroll-snap-align: start;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #page2 { background: #222; }
    #progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      width: 0%;
      background: linear-gradient(to right, #09f, #f09);
      z-index: 10;
    }
    #visual {
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: flex;
      z-index: 1;
    }
    #visual div {
      flex: 1;
      transition: opacity 0.1s linear;
    }
    #vis1 { background: rgba(0,150,255,0.15); }
    #vis2 { background: rgba(255,0,150,0.15); }
  </style>
</head>
<body>
  <div id="progress"></div>
  <div id="visual"><div id="vis1"></div><div id="vis2"></div></div>
  <section id="page1"><h1>Loop 1</h1></section>
  <section id="page2"></section>
  <section id="page3"><h1>Loop 2</h1></section>

  <script type="module">
    import { librosaLoopAnalysis } from '../src/index.js';

    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    const progressBar = document.getElementById('progress');
    const vis1 = document.getElementById('vis1');
    const vis2 = document.getElementById('vis2');

    vis1.style.opacity = '1';
    vis2.style.opacity = '0';

    const loops = [
      { url: 'loop1.mp3', buffer: null, source: null, gain: ctx.createGain(), filter: ctx.createBiquadFilter() },
      { url: 'loop2.mp3', buffer: null, source: null, gain: ctx.createGain(), filter: ctx.createBiquadFilter() }
    ];

    loops.forEach(l => {
      l.gain.gain.value = 0;
      l.filter.frequency.value = 20000;
      l.filter.connect(l.gain).connect(ctx.destination);
    });

    async function loadLoop(loop) {
      const res = await fetch(loop.url);
      const arrayBuffer = await res.arrayBuffer();
      loop.buffer = await ctx.decodeAudioData(arrayBuffer);
      const analysis = await librosaLoopAnalysis(loop.buffer);
      loop.loopStart = analysis.loopStart;
      loop.loopEnd = analysis.loopEnd;
    }

    await Promise.all(loops.map(loadLoop));

    function createSources() {
      loops.forEach(loop => {
        loop.source = ctx.createBufferSource();
        loop.source.buffer = loop.buffer;
        loop.source.loop = true;
        loop.source.loopStart = loop.loopStart;
        loop.source.loopEnd = loop.loopEnd;
        loop.source.connect(loop.filter);
        loop.source.start();
      });
    }

    createSources();

    function updateScroll() {
      const ratio = window.scrollY / (document.body.scrollHeight - innerHeight);

      progressBar.style.width = `${(ratio * 100).toFixed(2)}%`;

      let t;
      if (ratio < 0.5) {
        t = ratio / 0.5;
        loops[0].gain.gain.value = 1 - t;
        loops[1].gain.gain.value = t;
        loops[1].filter.type = 'lowpass';
        loops[1].filter.frequency.value = 500 + t * 19500;
        loops[0].filter.type = 'highpass';
        loops[0].filter.frequency.value = 500 + t * 19500;
        loops[0].source.playbackRate.value = 1;
        loops[1].source.playbackRate.value = 1 + t * 0.05;
      } else {
        t = (ratio - 0.5) / 0.5;
        loops[0].gain.gain.value = 1 - t;
        loops[1].gain.gain.value = t;
        loops[1].filter.type = 'lowpass';
        loops[1].filter.frequency.value = 500 + (1 - t) * 19500;
        loops[0].filter.type = 'highpass';
        loops[0].filter.frequency.value = 500 + t * 19500;
        loops[0].source.playbackRate.value = 1 - t * 0.05;
        loops[1].source.playbackRate.value = 1;
      }

      vis1.style.opacity = (1 - ratio).toFixed(3);
      vis2.style.opacity = ratio.toFixed(3);
    }

    window.addEventListener('scroll', updateScroll);
    updateScroll();
  </script>
</body>
</html>
